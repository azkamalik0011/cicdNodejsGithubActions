pipeline {
    agent any

    environment {
        SSH_KEY = credentials('node-ssh')
        EC2_USER = 'ubuntu'
        EC2_HOST = 'ec2-3-228-21-145.compute-1.amazonaws.com'
        GIT_REPO = 'https://github.com/azkamalik0011/cicdNodejsGithubActions.git'
        REPO_FOLDER = 'cicdNodejsGithubActions'
    }

    stages {
        stage('Clone Repository') {
            steps {
                script {
                    sshagent(['node-ssh']) {
                        // Check if the repository folder already exists
                        def folderExists = ssh(script: "ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} '[ -d ${REPO_FOLDER} ] && echo true || echo false'", returnStatus: true).trim()

                        if (folderExists == 0) {
                            echo "Repository folder already exists. Skipping cloning."
                        } else {
                            sh "ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} 'git clone ${GIT_REPO} ${REPO_FOLDER}'"
                        }
                    }
                }
            }
        }

        stage('Run Docker Compose') {
            steps {
                script {
                    sshagent(['node-ssh']) {
                        sh "ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} 'cd ${REPO_FOLDER} && docker-compose down -v && docker-compose up -d'"
                    }
                }
            }
        }
    }
}
